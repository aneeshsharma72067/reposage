generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EventType {
  PUSH
  PR_OPENED
  PR_MERGED
}

enum AnalysisStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum FindingType {
  API_BREAK
  ARCH_VIOLATION
  REFACTOR_SUGGESTION
}

enum SeverityLevel {
  INFO
  WARNING
  CRITICAL
}

model User {
  id            String               @id @default(uuid())
  githubUserId  BigInt               @unique @map("github_user_id")
  githubLogin   String               @map("github_login")
  avatarUrl     String?              @map("avatar_url")
  createdAt     DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  installations GithubInstallation[]

  @@map("users")
}

model GithubInstallation {
  id                String       @id @default(uuid())
  installationId    BigInt       @unique @map("installation_id")
  accountLogin      String       @map("account_login")
  accountType       String       @map("account_type")
  installedByUserId String       @map("installed_by_user_id")
  installedByUser   User         @relation(fields: [installedByUserId], references: [id], onDelete: Cascade)
  repositories      Repository[]
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("github_installations")
}

model Repository {
  id             String             @id @default(uuid())
  githubRepoId   BigInt             @unique @map("github_repo_id")
  installationId String             @map("installation_id")
  name           String
  fullName       String             @map("full_name")
  private        Boolean            @map("private")
  defaultBranch  String?            @map("default_branch")
  ownerLogin     String             @map("owner_login")
  ownerType      String             @map("owner_type")
  status         String             @default("idle") @map("status")
  isActive       Boolean            @default(true) @map("is_active")
  createdAt      DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  installation   GithubInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  events         Event[]
  findings       Finding[]

  @@index([installationId])
  @@map("repositories")
}

model Event {
  id            String        @id @default(uuid())
  repositoryId  String        @map("repository_id")
  githubEventId String?       @map("github_event_id")
  type          EventType
  payload       Json
  processed     Boolean       @default(false)
  createdAt     DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  repository    Repository    @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  analysisRuns  AnalysisRun[]

  @@index([repositoryId])
  @@map("events")
}

model AnalysisRun {
  id           String         @id @default(uuid())
  eventId      String         @map("event_id")
  status       AnalysisStatus @default(PENDING)
  startedAt    DateTime?      @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime?      @map("completed_at") @db.Timestamptz(6)
  errorMessage String?        @map("error_message")
  event        Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  findings     Finding[]

  @@index([eventId])
  @@map("analysis_runs")
}

model Finding {
  id            String        @id @default(uuid())
  analysisRunId String        @map("analysis_run_id")
  repositoryId  String        @map("repository_id")
  type          FindingType
  severity      SeverityLevel
  title         String
  description   String
  metadata      Json?
  createdAt     DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  analysisRun   AnalysisRun   @relation(fields: [analysisRunId], references: [id], onDelete: Cascade)
  repository    Repository    @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([repositoryId])
  @@index([severity])
  @@index([analysisRunId])
  @@map("findings")
}
